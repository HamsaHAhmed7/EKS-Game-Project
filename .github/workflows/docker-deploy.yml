name: Docker Build & Deploy

on:
  push:
    branches: [main]
    paths:
      - app/**
  workflow_dispatch:

permissions:
  id-token: write
  contents: write

env:
  AWS_REGION: eu-west-2
  ECR_REPOSITORY: eks-game-2048

jobs:
  build-scan-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: aws auth
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: eu-west-2

      - name: ecr login
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: ecr repo
        run: |
          aws ecr describe-repositories \
            --repository-names "$ECR_REPOSITORY" \
            --region "$AWS_REGION" \
          || aws ecr create-repository \
            --repository-name "$ECR_REPOSITORY" \
            --region "$AWS_REGION"

      - name: build image
        working-directory: app
        run: |
          docker build -t "$ECR_REPOSITORY:$GITHUB_SHA" .
          docker tag "$ECR_REPOSITORY:$GITHUB_SHA" \
            "${{ steps.ecr.outputs.registry }}/$ECR_REPOSITORY:$GITHUB_SHA"
          docker tag "$ECR_REPOSITORY:$GITHUB_SHA" \
            "${{ steps.ecr.outputs.registry }}/$ECR_REPOSITORY:latest"

      - name: trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          severity: CRITICAL,HIGH
          exit-code: 0
          format: table

      - name: push image
        run: |
          docker push "${{ steps.ecr.outputs.registry }}/$ECR_REPOSITORY:$GITHUB_SHA"
          docker push "${{ steps.ecr.outputs.registry }}/$ECR_REPOSITORY:latest"

      - name: update manifest
        run: |
          sed -i \
            "s|image: .*eks-game-2048.*|image: ${{ steps.ecr.outputs.registry }}/$ECR_REPOSITORY:$GITHUB_SHA|g" \
            infra/kubernetes/app.yaml

      - name: commit manifest
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add infra/kubernetes/app.yaml
          if ! git diff --staged --quiet; then
            git commit -m "chore: bump image"
            git push
          fi
